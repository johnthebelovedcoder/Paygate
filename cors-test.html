<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS File Upload Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .container {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        input[type="text"], 
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        input[type="file"] {
            padding: 8px 0;
            border: 1px dashed #ccc;
            background-color: #f8f9fa;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            color: #2e7d32;
        }
        .error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }
        .loading {
            display: none;
            margin: 10px 0;
            color: #7f8c8d;
        }
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #fff;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .test-section h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .test-button {
            margin-right: 10px;
            margin-bottom: 10px;
            background-color: #2ecc71;
        }
        .test-button:hover {
            background-color: #27ae60;
        }
        .test-results {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        .test-result.success {
            background-color: #e8f5e9;
            border-left: 3px solid #4caf50;
        }
        .test-result.error {
            background-color: #ffebee;
            border-left: 3px solid #f44336;
        }
        .test-result.warning {
            background-color: #fff8e1;
            border-left: 3px solid #ffc107;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
            margin: 5px 0;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background-color: #fff;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .code-block {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>CORS File Upload Test</h1>
    <p>This page helps you test CORS file uploads to your API. Use the tabs below to navigate between different test options.</p>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('quick-test')">Quick Test</div>
        <div class="tab" onclick="switchTab('file-upload')">File Upload</div>
        <div class="tab" onclick="switchTab('cors-tests')">CORS Tests</div>
        <div class="tab" onclick="switchTab('documentation')">Documentation</div>
    </div>
    
    <!-- Quick Test Tab -->
    <div id="quick-test" class="tab-content active">
        <div class="container">
            <h2>Quick CORS Test</h2>
            <p>Run a quick test to check if CORS is properly configured on your server.</p>
            
            <div class="form-group">
                <label for="test-endpoint">Endpoint to Test:</label>
                <input type="text" id="test-endpoint" value="http://localhost:8000/upload-test" placeholder="Enter your API endpoint">
            </div>
            
            <div class="test-buttons">
                <button class="test-button" onclick="testCorsPreflight()">Test CORS Preflight</button>
                <button class="test-button" onclick="testSimpleRequest()">Test Simple Request</button>
                <button class="test-button" onclick="testWithAuth()">Test with Auth</button>
            </div>
            
            <div id="quick-test-results" class="test-results">
                <p>Test results will appear here...</p>
            </div>
        </div>
    </div>
    
    <!-- File Upload Tab -->
    <div id="file-upload" class="tab-content">
        <div class="container">
            <h2>File Upload Test</h2>
            <p>Test file uploads to your API endpoint with custom headers and authentication.</p>
            
            <div class="form-group">
                <label for="apiUrl">API Endpoint:</label>
                <input type="text" id="apiUrl" value="http://localhost:8000/upload" placeholder="Enter your upload endpoint">
            </div>
            
            <div class="form-group">
                <label for="authToken">Authorization Token (if required):</label>
                <input type="text" id="authToken" placeholder="Bearer your_token_here">
            </div>
            
            <div class="form-group">
                <label for="fileInput">Select a file to upload:</label>
                <input type="file" id="fileInput">
            </div>
            
            <div class="form-group">
                <button onclick="uploadFile()" id="uploadButton">Upload File</button>
                <div id="uploadLoading" class="loading">
                    <div class="spinner"></div>
                    <span>Uploading file...</span>
                </div>
            </div>
            
            <div id="uploadResult" class="result">
                <!-- Results will be displayed here -->
            </div>
        </div>
    </div>
    
    <!-- CORS Tests Tab -->
    <div id="cors-tests" class="tab-content">
        <div class="container">
            <h2>Comprehensive CORS Tests</h2>
            <p>Run a series of tests to verify CORS configuration on your server.</p>
            
            <div class="test-buttons">
                <button class="test-button" onclick="runAllTests()">Run All Tests</button>
                <button class="test-button" onclick="testCorsEndpoints()">Test CORS Endpoints</button>
                <button class="test-button" onclick="testAuthEndpoints()">Test Auth Endpoints</button>
                <button class="test-button" onclick="testFileUploads()">Test File Uploads</button>
            </div>
            
            <div id="testResults" class="test-results">
                <p>Test results will appear here...</p>
            </div>
        </div>
    </div>
    
    <!-- Documentation Tab -->
    <div id="documentation" class="tab-content">
        <div class="container">
            <h2>CORS Configuration Guide</h2>
            
            <h3>Backend CORS Configuration</h3>
            <p>Ensure your FastAPI backend has the following CORS middleware configuration:</p>
            
            <div class="code-block">
                from fastapi import FastAPI<br>
                from fastapi.middleware.cors import CORSMiddleware<br>
                <br>
                app = FastAPI()<br>
                <br>
                # CORS Middleware<br>
                app.add_middleware(<br>
                    CORSMiddleware,<br>
                    allow_origins=["http://localhost:3000", "http://127.0.0.1:3000"],<br>
                    allow_credentials=True,<br>
                    allow_methods=["*"],<br>
                    allow_headers=["*"],<br>
                    expose_headers=["*"]<br>
                )
            </div>
            
            <h3>Frontend Fetch Example</h3>
            <p>Example of making a CORS request from the frontend:</p>
            
            <div class="code-block">
                async function uploadFile(file) {<br>
                    const formData = new FormData();<br>
                    formData.append('file', file);<br>
                    <br>
                    try {<br>
                        const response = await fetch('http://localhost:8000/upload', {<br>
                            method: 'POST',<br>
                            headers: {<br>
                                'Authorization': 'Bearer your_token_here'<br>
                            },<br>
                            credentials: 'include',<br>
                            body: formData<br>
                        });<br>
                        <br>
                        if (!response.ok) {<br>
                            throw new Error(`HTTP error! status: ${response.status}`);<br>
                        }<br>
                        <br>
                        return await response.json();<br>
                    } catch (error) {<br>
                        console.error('Upload failed:', error);<br>
                        throw error;<br>
                    }<br>
                }
            </div>
            
            <h3>Troubleshooting CORS Issues</h3>
            <ul>
                <li>Ensure the server is sending the correct CORS headers in the response</li>
                <li>Check that the request includes the correct <code>Origin</code> header</li>
                <li>For credentialed requests, ensure <code>credentials: 'include'</code> is set</li>
                <li>Verify that the server is handling OPTIONS (preflight) requests correctly</li>
                <li>Check the browser's console for detailed error messages</li>
            </ul>
        </div>
    </div>
    
    <script>
        // Tab switching functionality
        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Deactivate all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activate the selected tab
            document.getElementById(tabId).classList.add('active');
            
            // Find and activate the clicked tab
            const tabs = document.querySelectorAll('.tab');
            for (let tab of tabs) {
                if (tab.textContent.trim().toLowerCase() === tabId.replace('-', ' ')) {
                    tab.classList.add('active');
                    break;
                }
            }
        }
        
        // Helper function to show loading state
        function showLoading(elementId, show) {
            const loadingElement = document.getElementById(elementId);
            if (loadingElement) {
                loadingElement.style.display = show ? 'block' : 'none';
            }
        }
        
        // Helper function to add a test result
        function addTestResult(message, isError = false, data = null) {
            const testResults = document.getElementById('testResults');
            if (!testResults) return;
            
            const resultItem = document.createElement('div');
            resultItem.className = `test-result ${isError ? 'error' : 'success'}`;
            
            let resultHTML = `<strong>${isError ? '❌' : '✅'} ${message}</strong>`;
            
            if (data) {
                if (typeof data === 'object') {
                    resultHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    resultHTML += `<pre>${data}</pre>`;
                }
            }
            
            resultItem.innerHTML = resultHTML;
            testResults.insertBefore(resultItem, testResults.firstChild);
            
            // Auto-scroll to the top
            testResults.scrollTop = 0;
        }
        
        // Helper function to add a quick test result
        function addQuickTestResult(message, isError = false, data = null) {
            const testResults = document.getElementById('quick-test-results');
            if (!testResults) return;
            
            const resultItem = document.createElement('div');
            resultItem.className = `test-result ${isError ? 'error' : 'success'}`;
            
            let resultHTML = `<strong>${isError ? '❌' : '✅'} ${message}</strong>`;
            
            if (data) {
                if (typeof data === 'object') {
                    resultHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    resultHTML += `<pre>${data}</pre>`;
                }
            }
            
            resultItem.innerHTML = resultHTML;
            testResults.insertBefore(resultItem, testResults.firstChild);
        }
        
        // 1. Test CORS Preflight
        async function testCorsPreflight() {
            const endpoint = document.getElementById('test-endpoint').value.trim() || 'http://localhost:8000/upload-test';
            
            try {
                addQuickTestResult(`Testing CORS preflight to ${endpoint}...`);
                
                const response = await fetch(endpoint, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'content-type,authorization',
                        'Origin': window.location.origin
                    },
                    mode: 'cors'
                });
                
                // Get CORS headers
                const corsHeaders = {};
                response.headers.forEach((value, key) => {
                    if (key.toLowerCase().startsWith('access-control-')) {
                        corsHeaders[key] = value;
                    }
                });
                
                if (response.status === 204 || response.status === 200) {
                    addQuickTestResult(
                        `✅ CORS preflight successful! Status: ${response.status} ${response.statusText}`,
                        false,
                        {
                            status: response.status,
                            statusText: response.statusText,
                            headers: corsHeaders
                        }
                    );
                } else {
                    throw new Error(`Unexpected status: ${response.status} ${response.statusText}`);
                }
                
                // Also log the headers to console
                console.log('CORS Headers:', corsHeaders);
                
            } catch (error) {
                addQuickTestResult(
                    `❌ CORS preflight failed: ${error.message}`,
                    true,
                    error
                );
                console.error('CORS preflight error:', error);
            }
        }
        
        // 2. Test Simple Request
        async function testSimpleRequest() {
            const endpoint = document.getElementById('test-endpoint').value.trim() || 'http://localhost:8000/upload-test';
            
            try {
                addQuickTestResult(`Testing simple CORS request to ${endpoint}...`);
                
                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    mode: 'cors'
                });
                
                const data = await response.json();
                
                // Get CORS headers
                const corsHeaders = {};
                response.headers.forEach((value, key) => {
                    if (key.toLowerCase().startsWith('access-control-')) {
                        corsHeaders[key] = value;
                    }
                });
                
                if (response.ok) {
                    addQuickTestResult(
                        `✅ Simple CORS request successful! Status: ${response.status} ${response.statusText}`,
                        false,
                        {
                            status: response.status,
                            statusText: response.statusText,
                            headers: corsHeaders,
                            data: data
                        }
                    );
                } else {
                    throw new Error(`Request failed: ${response.status} ${response.statusText}`);
                }
                
            } catch (error) {
                addQuickTestResult(
                    `❌ Simple CORS request failed: ${error.message}`,
                    true,
                    error
                );
                console.error('Simple CORS request error:', error);
            }
        }
        
        // 3. Test with Authentication
        async function testWithAuth() {
            const endpoint = document.getElementById('test-endpoint').value.trim() || 'http://localhost:8000/upload';
            const authToken = document.getElementById('authToken').value.trim();
            
            if (!authToken) {
                addQuickTestResult('Please provide an authorization token for this test', true);
                return;
            }
            
            try {
                addQuickTestResult(`Testing authenticated request to ${endpoint}...`);
                
                // First, test the preflight with auth
                const preflightResponse = await fetch(endpoint, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'content-type,authorization',
                        'Origin': window.location.origin
                    },
                    mode: 'cors'
                });
                
                // Then test the actual request with auth
                const formData = new FormData();
                formData.append('test', 'test file content');
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': authToken,
                        'Origin': window.location.origin
                    },
                    body: formData,
                    mode: 'cors',
                    credentials: 'include'
                });
                
                let responseData;
                try {
                    responseData = await response.json();
                } catch (e) {
                    responseData = { error: 'Could not parse JSON response', text: await response.text() };
                }
                
                // Get CORS headers
                const corsHeaders = {};
                response.headers.forEach((value, key) => {
                    if (key.toLowerCase().startsWith('access-control-')) {
                        corsHeaders[key] = value;
                    }
                });
                
                if (response.ok) {
                    addQuickTestResult(
                        `✅ Authenticated request successful! Status: ${response.status} ${response.statusText}`,
                        false,
                        {
                            status: response.status,
                            statusText: response.statusText,
                            headers: corsHeaders,
                            data: responseData
                        }
                    );
                } else {
                    throw new Error(`Request failed: ${response.status} ${response.statusText}`);
                }
                
            } catch (error) {
                addQuickTestResult(
                    `❌ Authenticated request failed: ${error.message}`,
                    true,
                    error
                );
                console.error('Authenticated request error:', error);
            }
        }
        
        // 4. File Upload Function
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const authToken = document.getElementById('authToken').value.trim();
            const uploadResult = document.getElementById('uploadResult');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                uploadResult.innerHTML = '<div class="error">❌ Please select a file to upload</div>';
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            
            // Show loading state
            showLoading('uploadLoading', true);
            uploadResult.innerHTML = '';
            
            try {
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = authToken;
                }
                
                // First, test the preflight
                try {
                    await fetch(apiUrl, {
                        method: 'OPTIONS',
                        headers: {
                            'Access-Control-Request-Method': 'POST',
                            'Access-Control-Request-Headers': 'content-type,authorization',
                            'Origin': window.location.origin
                        },
                        mode: 'cors'
                    });
                } catch (preflightError) {
                    console.warn('Preflight request failed, but continuing with upload attempt', preflightError);
                }
                
                // Then make the actual upload request
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: formData,
                    credentials: 'include',
                    mode: 'cors'
                });
                
                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    result = { error: 'Could not parse JSON response', text: await response.text() };
                }
                
                if (response.ok) {
                    uploadResult.innerHTML = `
                        <div class="success">
                            <strong>✅ File uploaded successfully!</strong>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                    
                    // Also add to test results
                    addTestResult(
                        `File upload to ${apiUrl} successful!`,
                        false,
                        {
                            status: response.status,
                            statusText: response.statusText,
                            data: result
                        }
                    );
                } else {
                    throw new Error(result.detail || result.message || 'Unknown error occurred');
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                const errorMessage = error.message || 'Failed to upload file';
                uploadResult.innerHTML = `
                    <div class="error">
                        <strong>❌ Error: ${errorMessage}</strong>
                        <pre>${JSON.stringify(error, null, 2)}</pre>
                    </div>
                `;
                
                // Also add to test results
                addTestResult(
                    `File upload to ${apiUrl} failed: ${errorMessage}`,
                    true,
                    error
                );
            } finally {
                showLoading('uploadLoading', false);
            }
        }
        
        // 5. Run all CORS tests
        async function runAllTests() {
            // Clear previous results
            document.getElementById('testResults').innerHTML = '<p>Running tests...</p>';
            
            // Run tests in sequence
            await testCorsEndpoints();
            await testAuthEndpoints();
            await testFileUploads();
            
            addTestResult('All tests completed!');
        }
        
        // 6. Test CORS endpoints
        async function testCorsEndpoints() {
            const endpoints = [
                'http://localhost:8000/upload-test',
                'http://localhost:8000/upload',
                'http://localhost:8000/api/auth/login',
                'http://localhost:8000/api/auth/me'
            ];
            
            for (const endpoint of endpoints) {
                await testEndpointCors(endpoint);
            }
        }
        
        // 7. Test a single endpoint for CORS
        async function testEndpointCors(endpoint) {
            addTestResult(`Testing CORS for ${endpoint}...`);
            
            try {
                // Test OPTIONS (preflight)
                const optionsResponse = await fetch(endpoint, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'content-type,authorization',
                        'Origin': window.location.origin
                    },
                    mode: 'cors'
                });
                
                // Get CORS headers
                const corsHeaders = {};
                optionsResponse.headers.forEach((value, key) => {
                    if (key.toLowerCase().startsWith('access-control-')) {
                        corsHeaders[key] = value;
                    }
                });
                
                addTestResult(
                    `CORS preflight for ${endpoint}`,
                    !(optionsResponse.status === 204 || optionsResponse.status === 200),
                    {
                        status: optionsResponse.status,
                        statusText: optionsResponse.statusText,
                        headers: corsHeaders
                    }
                );
                
                // Test GET request (if applicable)
                if (!endpoint.includes('/upload')) {
                    try {
                        const getResponse = await fetch(endpoint, {
                            method: 'GET',
                            headers: {
                                'Origin': window.location.origin
                            },
                            mode: 'cors'
                        });
                        
                        addTestResult(
                            `GET request to ${endpoint}`,
                            !getResponse.ok,
                            {
                                status: getResponse.status,
                                statusText: getResponse.statusText
                            }
                        );
                    } catch (error) {
                        addTestResult(
                            `GET request to ${endpoint} failed`,
                            true,
                            error
                        );
                    }
                }
                
            } catch (error) {
                addTestResult(
                    `CORS test for ${endpoint} failed`,
                    true,
                    error
                );
            }
        }
        
        // 8. Test authentication endpoints
        async function testAuthEndpoints() {
            addTestResult('Testing authentication endpoints...');
            
            try {
                // Test login
                const loginResponse = await fetch('http://localhost:8000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({
                        username: 'admin@example.com',
                        password: 'password123'
                    }),
                    credentials: 'include',
                    mode: 'cors'
                });
                
                let loginData;
                try {
                    loginData = await loginResponse.json();
                } catch (e) {
                    loginData = { error: 'Could not parse JSON response', text: await loginResponse.text() };
                }
                
                if (loginResponse.ok && loginData.access_token) {
                    addTestResult(
                        '✅ Login successful',
                        false,
                        { token: loginData.access_token ? '***token_received***' : 'No token received' }
                    );
                    
                    // Test protected endpoint with token
                    const token = loginData.access_token;
                    const meResponse = await fetch('http://localhost:8000/api/auth/me', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Origin': window.location.origin
                        },
                        credentials: 'include',
                        mode: 'cors'
                    });
                    
                    let meData;
                    try {
                        meData = await meResponse.json();
                    } catch (e) {
                        meData = { error: 'Could not parse JSON response', text: await meResponse.text() };
                    }
                    
                    addTestResult(
                        meResponse.ok ? '✅ Access to protected endpoint successful' : '❌ Access to protected endpoint failed',
                        !meResponse.ok,
                        {
                            status: meResponse.status,
                            statusText: meResponse.statusText,
                            data: meData
                        }
                    );
                    
                } else {
                    throw new Error(`Login failed: ${loginResponse.status} ${loginResponse.statusText}`);
                }
                
            } catch (error) {
                addTestResult(
                    '❌ Authentication test failed',
                    true,
                    error
                );
            }
        }
        
        // 9. Test file uploads
        async function testFileUploads() {
            addTestResult('Testing file uploads...');
            
            try {
                // First, get an auth token
                const loginResponse = await fetch('http://localhost:8000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({
                        username: 'admin@example.com',
                        password: 'password123'
                    }),
                    credentials: 'include',
                    mode: 'cors'
                });
                
                if (!loginResponse.ok) {
                    throw new Error(`Login failed: ${loginResponse.status} ${loginResponse.statusText}`);
                }
                
                const loginData = await loginResponse.json();
                const token = loginData.access_token;
                
                // Test file upload
                const formData = new FormData();
                formData.append('file', new Blob(['Test file content'], { type: 'text/plain' }), 'test.txt');
                
                const uploadResponse = await fetch('http://localhost:8000/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Origin': window.location.origin
                    },
                    body: formData,
                    credentials: 'include',
                    mode: 'cors'
                });
                
                let uploadData;
                try {
                    uploadData = await uploadResponse.json();
                } catch (e) {
                    uploadData = { error: 'Could not parse JSON response', text: await uploadResponse.text() };
                }
                
                addTestResult(
                    uploadResponse.ok ? '✅ File upload successful' : '❌ File upload failed',
                    !uploadResponse.ok,
                    {
                        status: uploadResponse.status,
                        statusText: uploadResponse.statusText,
                        data: uploadData
                    }
                );
                
            } catch (error) {
                addTestResult(
                    '❌ File upload test failed',
                    true,
                    error
                );
            }
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('CORS Test Page Loaded');
            console.log('Current Origin:', window.location.origin);
            
            // Set the auth token from localStorage if available
            const savedToken = localStorage.getItem('authToken');
            if (savedToken) {
                document.getElementById('authToken').value = savedToken;
            }
            
            // Auto-save auth token when changed
            document.getElementById('authToken').addEventListener('change', function() {
                localStorage.setItem('authToken', this.value);
            });
        });
    </script>
</body>
</html>
